---
title: "Prey Data Aggregation and Exploration"
author: "Maddee Rubenson & Erin Cain (FlowWest)"
output:
  html_document:
    code_folding: hide
    theme: journal
    highlight: tango
    toc: true
---


```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(knitr)
library(readxl)
library(sf)
library(DT)
library(leaflet)
library(leaflet.esri)
library(zooper)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

options(scipen=999)


```

`r Sys.Date()`

## Standardized Dataset Format

Formatting and data descriptions for standardized datasets.

```{r, echo = FALSE}
datasets <- read_excel('DatasetFormat.xlsx', sheet = "Description")

prey_desc <- datasets %>% filter(Which == 'prey') %>% select(-Which)

datatable(prey_desc, caption = 'Prey data standardized data description and presence or absence in aggregated datasets',
          options = list(
              pageLength = 12
          )) %>% 
  formatStyle(columns = c('Corline', 'Cordoleani',  'Zeug - Merced', 'Zeug - San Joaquin', 
                          'Montgomery', 'Guignard', 'Zooper'), 
              backgroundColor = styleEqual(c(TRUE, FALSE), c('#9FE39A', '#DB9E95')))


fish_desc <- datasets %>% filter(Which == 'fish') %>% select(-Which)

datatable(fish_desc, caption = "Fish data standardized data description and  presence or absence in aggregated datasets") %>% 
  formatStyle(columns = c('Corline', 'Cordoleani',  'Zeug - Merced', 'Zeug - San Joaquin', 
                          'Montgomery', 'Guignard', 'Zooper'), 
              backgroundColor = styleEqual(c(TRUE, FALSE), c('#9FE39A', '#DB9E95')))

env_desc <- datasets %>% filter(Which == 'environmental') %>% select(-Which)

datatable(env_desc, caption = 'Environmental data standardized data description and  presence or absence in aggregated datasets') %>% 
  formatStyle(columns = c('Corline', 'Cordoleani',  'Zeug - Merced', 'Zeug - San Joaquin', 
                          'Montgomery', 'Guignard', 'Zooper'), 
              backgroundColor = styleEqual(c(TRUE, FALSE), c('#9FE39A', '#DB9E95'))) 
```

<!-- ### Zooplankton -->

<!-- -   `date`: YYYY-MM-DD -->

<!-- -   `prey_density`: prey per unit volume: total organisms/m\^3 -->

<!-- -   `life_stage`: Adult, Larvae, Nymph, Pupae -->

<!-- -   `size_class`: ?? -->

<!-- -   `habitat_type` - perennial instream, floodplain, side channel -->

<!-- -   `gear_type` - kick net, drift net, etc. -->

<!-- -   `watershed`: HUC8 -->

<!-- -   `sample_id` - for joining to growth and environmental datasets -->

<!-- -   `author`- dataset author -->

<!-- -   `location` -->

<!-- ### Environmental Variables -->

<!-- -   `date`: YYYY-MM-DD -->

<!-- -   `sample_id` -->

<!-- -   `author`: dataset author -->

<!-- -   `temperature`: instream temperature (Celsius) -->

<!-- -   `dissolved_oxygen`: dissolved oxygen (mg/l) -->

<!-- ### Fish -->

<!-- -   `date`: YYYY-MM-DD -->

<!-- -   `fish_id` -->

<!-- -   `sample_id` -->

<!-- -   `mass` - grams -->

<!-- -   `fork_length` - millimeters -->

<!-- -   `site_name` -->

<!-- -   `watershed`: HUC8  -->

# Load Datasets {.tabset .tabset-fade .tabset-pills}

### Corline et al. {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

```{r}
corline_raw_zoop <- read_excel("corline/Zoop2013_2016.xlsx") 

kable(head(corline_raw_zoop, 5))
```

#### Data Standardization

-   Corline defined prey density as `Count` per `Volume subsampled (ml)`

-   converted volume subsampled from ml to liters

-   Along with `gear_type` included in the datest are the number of throws (`n_throws`) and mesh size (`mesh_size_microns`). Mesh size is used to determine the `size_class` variable.

-   Variables Removed: `Split Fraction`, `Class`, `Subclass`, `Order`, `Genus`, `Family`

-   Left `species` column

-   Fixed naming conventions of the sampling locations (`sample_id`)

-   TO DO: reconcile inconsistent species spelling names

```{r, warnings = FALSE, message=FALSE}
corline_zoop <- corline_raw_zoop %>%
  rename(location = Location, 
         gear_type = Method, 
         life_stage = `Life Stage`) %>%
  mutate(prey_density = Count/(`Volume subsampled (ml)`*0.001), #convert ml to L and calculate prey density
         # mutate(prey_density = Count/(`Total Volume (ml)`*1e-6), #convert ml to L and calculate prey density 
         Date = as_date(Date)) %>%
  select(-c(`Split Fraction`:`Volume subsampled (ml)`), -Count, -c(Phylum:Genus)) %>%
  rename(sample_id = Field, 
         species = Species, 
         n_throws = Throws, 
         mesh_size_microns = `Mesh Size (microns)`,
         date = Date) %>%
  select(-`Total Volume (ml)`, -`Ring Size (cm)`) %>%
  mutate(author = "Corline",
         size_class = "meso",
         species = tolower(species),
         gear_type = tolower(gear_type),
         mesh_size = mesh_size_microns) 

table(corline_zoop$species) 
#Numeric sample Ids must be standardized with Fields. Looks like 2015 data has 1 - 9 as sample Id while data from 2013 has Field 1 - Field 9. This is updated to have the sample_ids as follows, where the NA corresponds to the sites on the Sacramento River. 
tmp_change_names <- corline_zoop[corline_zoop$sample_id %in% c(1:10), ] %>%
  mutate(sample_id = paste0('Field ', sample_id))
tmp_names_with_field <- corline_zoop[!(corline_zoop$sample_id %in% c(1:10)), ]
corline_zoop <- bind_rows(tmp_change_names, tmp_names_with_field)

# this fixes he spelling differences in species column 
corline_zoop <- corline_zoop %>%
  mutate(species = case_when(species %in% c("harpacticoid", "harpacticoida") ~ "harpacticoida",
                             species %in% c("illyocryptidae", "ilyocryptidae") ~ "ilyocryptidae",
                             species %in% c("schaploberis", "schaphloberis") ~ "schaphloberis", 
                             species == "species" ~ NA_character_, 
                             TRUE ~ species))  %>% glimpse


corline_zoop <- corline_zoop %>%
  select(-n_throws, -mesh_size_microns)

#kable(head(corline_zoop, 5))

```

##### Location Data Standardization and Merge

-   location of the fields (Knaggs Ranch) were provided by author

-   location of inlet canal (Toe Drain) was determined based on best professional judgement and the paper Corline et al.

-   location of the Sacramento River sampling site was provided in the paper Corline et al. as Sherwood Harbor

-   defined `habitat_type` based on best professional judgement

```{r}

corline_locations <- data.frame(
  location = c('Knaggs Ranch', 'Sacramento River', 'Toe Drain'),
  habitat_type = c('floodplain', 'perennial instream', 'agricultural canal'), 
  lat = c(38.70151, 38.52353, 38.70511),
  lon = c( -121.66996, -121.53840, -121.67041)
)

corline_locations_sf <- st_as_sf(corline_locations, coords = c('lon', 'lat'))

# leaflet(corline_locations_sf) %>%
#   addEsriBasemapLayer(esriBasemapLayers$Imagery, 
#                       autoLabels=TRUE, group = 'Esri Basemap') %>%
#   addMarkers(popup = ~paste0(corline_locations_sf$location, ' ', corline_locations_sf$habitat_type )) 

```

##### Combine locations and zooplankton dataset

```{r}
corline_zoop <- merge(corline_zoop, corline_locations, by = "location")

# add watershed column 
corline_zoop <- corline_zoop %>%
  mutate(watershed = ifelse(location == "Sacramento River", "Sacramento River", "Yolo Bypass"),
         site = ifelse(location == "Sacramento River", "Sherwood Harbor", location)) %>%
  mutate(site = paste0(location, "-", sample_id)) %>%
  select(-sample_id, -location)


kable(head(corline_zoop, 5))
```

```{r}
# save to data folder
corline_prey_data <- corline_zoop

# usethis::use_data(corline_prey_data)

```

#### Data Exploration

##### Location Background Information

-   There are 9 sampling sites located on agricultural fields[^1]

-   There is one sampling location on the Sacramento River [^2]

-   There is one sampling location on an Inlet Canal[^3]

[^1]: constructed nine 0.79-ha experimental units on Knaggs Ranch in the north end of the Yolo Bypass (Fig. 1). Fields were inundated on Febuary 5th 2013 with water from Knights Landing Ridge Cut, a channel that drains the Colusa Basin and supplies agricultural water to the Yolo Bypass, and were drained on March 27th 2013. Flow to the fields was variable and ranged from 0.3-0.5 meters. Flow rates into the fields ranged from 0.0 to 0.06 cubic meters per second. Each field was stocked with \*4500 juvenile Chinook Salmon from the Feather River Hatchery (Oroville, CA), which initially measured approximately 53.6 Â± 0.15 mm FL.

[^2]: Sacramento River Zooplankton: Zooplankton samples were collected concurrently during the study period at Sherwood Harbor on the Sacramento River by the California Department of Water Resources using methods from Sommer et al. (2001a, b, 2004). Samples were collected with a 153 lm mesh 0.5 m diameter Clark-Bumpus net equipped with a General Oceanics Flowmeter (Miami, FL, USA) and preserved in 5% formalin. Flow meter distance and net dimensions were used to calculate zooplankton per cubic meter.

[^3]: Inlet Canal: The source water inlet canal was sampled prior to inundation and then during weeks three, four, five, and six. To assess invertebrate diversity and abundance on different habitat types and the inlet canal, a 153 lm zooplankton net attached to5 m of rope was thrown the full 5-m distance and retrieved four times for a total volume of 1.92 cubic meters sampled per sample.

```{r, message=FALSE, warning=FALSE,echo = FALSE}
ggplot(corline_zoop, aes(species)) +
  geom_bar(aes(stat = 'count', fill = life_stage)) + 
  coord_flip() + 
  theme_minimal()
```

```{r}
ggplot(corline_zoop, aes(habitat_type)) +
  geom_bar(aes(stat = 'count', fill = life_stage)) + 
  coord_flip() + 
  theme_minimal()
```

### Cordoleani et al. {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

##### Raw Fish Data

```{r message=FALSE, warning=FALSE}
fish_growth_data_2019 <- read_csv("Cordoleani et al Sutter Bypass CVPIA 2020 2021/DailyCageFish_data_2019.csv")
fish_growth_data_2020 <- read_csv("Cordoleani et al Sutter Bypass CVPIA 2020 2021/DailyCageFish_data_2020.csv")

# combine 2019, 2020 data
total_fish_growth <- bind_rows(fish_growth_data_2019, fish_growth_data_2020)

# view snapshot or results
kable(head(total_fish_growth, 5))

# read in fork length data 
fork_length <- read.csv('Cordoleani et al Sutter Bypass CVPIA 2020 2021/CageSalmon_Growth.csv')
```

------------------------------------------------------------------------

##### Raw Prey Data

```{r message=FALSE, warning=FALSE}
prey_data_2019 <- read_csv("Cordoleani et al Sutter Bypass CVPIA 2020 2021/DailyZoopTemp_data_2019.csv")
prey_data_2020 <- read_csv("Cordoleani et al Sutter Bypass CVPIA 2020 2021/DailyZoopTemp_data_2020.csv") %>%  
  mutate(Date = lubridate::as_date(Date, format = "%d/%m/%y"))

# combine 2019, 2020 data
total_prey <- bind_rows(prey_data_2019, prey_data_2020) 

# view snapshot or results
kable(head(total_prey, 5))

cord_prey_new <- read.csv('Cordoleani et al Sutter Bypass CVPIA 2020 2021/tidy_zoop_density.csv')
```

------------------------------------------------------------------------

##### Raw Location Data

```{r}
cordoleani_locations_raw <- read.csv('Cordoleani et al Sutter Bypass CVPIA 2020 2021/Cage_Locations.csv')

kable(head(cordoleani_locations_raw, 5 ))
```

##### Raw Dissolved Oxygen Data

```{r}
cordoleani_do_raw <- read.csv('Cordoleani et al Sutter Bypass CVPIA 2020 2021/doboall.csv')

kable(head(cordoleani_do_raw, 5))
```

#### Data Standardization

##### Prey Data Standardization

-   Chose to not use interpolated or filled values for prey density

-   Removed temperature to include as a standalone dataset that can be mapped to this dataset using `sample_id` and `date`

-   Defined `sample_id` as `cage_id`

-   ~~TO DO: should likely remove the two zooplankton density columns. It is weird that those values do not add up to total prey_density.~~

-   mapped `Canal channel` and `Agriculture` to `agricultural canal`

-   mapped `Channel` and `River Channel` to `perennial instream`

-   mapped `Wetland` to `floodplain`

-   Changed units for `prey_density` from count/m\^3 to count/L

```{r}

cordoleani_zoop <- cord_prey_new %>% 
  rename(prey_density = value, # units are organisms/m^3 per Sutter 2020 report 
         sample_id = report_id,
         date = sample_date,
         location = region,
         species = taxa) %>%
  mutate(date = mdy(date),
         prey_density = prey_density/1000, # 1 m^3 = 1000 Liters 
         author = 'Cordoleani',
         habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' )))),
         watershed = case_when(location == "Butte Sink" ~ "Butte Creek", 
                            location == "Sacramento River" ~ "Sacramento River", 
                            location == "Feather River" ~ "Feather River", 
                            location %in% c("Lower Bypass", "Upper Bypass") ~ 
                              "Sutter Bypass"), 
         site = paste0(location, "-", sample_id),
         size_class = "meso",
         gear_type = "net throw",
         mesh_size = 150,
         species = tolower(species)) %>% 
         select(-location, -sample_id, -year) 
  

# cordoleani_zoop <- total_prey %>% 
#   select(cage_id:totprey_density,totcladocera_density, totpulex_density, mean_temperature, Report_type) %>% 
#   mutate(habitat_type = ifelse(is.na(total_prey$Type), total_prey$Report_type, total_prey$Type)) %>%
#   rename(prey_density = totprey_density, # units are organisms/m^3 per Sutter 2020 report 
#          location = Region,
#          sample_id = cage_id) %>%
#   filter(!is.na(prey_density)) %>%
#   mutate(prey_density = prey_density/1000, # 1 m^3 = 1000 Liters 
#          author = 'Cordoleani') %>%
#   select(-Type, -Report_type, -mean_temperature) %>%
#   rename(date = Date) %>%
#   select(-totcladocera_density, -totpulex_density) %>%
#   mutate(habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
#                                ifelse(habitat_type == 'Channel', 'perennial instream',
#                                       ifelse(habitat_type == "River Channel", 'perennial instream',
#                                              ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' ))))) %>%
#   mutate(watershed = case_when(location == "Butte Sink" ~ "Butte Creek", 
#                             location == "Sacramento River" ~ "Sacramento River", 
#                             location == "Feather River" ~ "Feather River", 
#                             location %in% c("Lower Bypass", "Upper Bypass") ~ 
#                               "Sutter Bypass"), 
#          site = paste0(location, "-", sample_id),
#          size_class = "meso",
#          gear_type = "net throw",
#          mesh_size = 150) %>%
#   select(-location, -sample_id) %>%
#   glimpse


# view data snapshot
kable(head(cordoleani_zoop, 5))

```

------------------------------------------------------------------------

##### Environmental Data Standardization

-   Chose to keep mean temperature and remove min and max temperature columns

-   

```{r}

cordoleani_enviro <- cordoleani_do_raw %>%
  select(Region, Report_type, 
         Date, DO_mgl, Temp_C, Report_ID) %>%
  rename(sample_id = Report_ID, 
         location = Region, 
         do_mg_l = DO_mgl, 
         temperature = Temp_C,
         date = Date,
         habitat_type = Report_type) %>%
  mutate(date = as_date(date),
         author = 'Cordoleani') %>%
  mutate(habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' ))))) %>%
  mutate(watershed = case_when(location == "Butte Sink" ~ "Butte Creek", 
                            location == "Sacramento River" ~ "Sacramento River", 
                            location == "Feather River" ~ "Feather River", 
                            location %in% c("Lower Bypass", "Upper Bypass") ~ "Sutter Bypass"), 
         site = paste0(location, "-", sample_id)) %>%
  select(-location, -sample_id) %>%
  glimpse


# view data snapshot
kable(head(cordoleani_enviro, 5))
```

------------------------------------------------------------------------

##### Fish Data Standardization

-   Defined `sample_id` as `cage_id`

-   merged fish growth dataset with fork length dataset, which we acquired separately

-   used average `fork_length` per site because fish growth dataset wasn't granular enough in terms of date and time to merge with fork length dataset.

-   used same mapping as shown in prey data standardization

```{r}
cordoleani_fish <- total_fish_growth %>% 
  select(fish_id:mass) %>% 
  rename(habitat_type = Type, 
         location = Region,
         sample_id = cage_id) %>%
  filter(!is.na(mass)) %>%
  mutate(author = 'Cordoleani')  %>%
  rename(date = Date)

cord_fork_length <- fork_length %>%
  rename(sample_id = Location, 
         fork_length = FL) %>%
  select(sample_id, fork_length) %>%
  group_by(sample_id) %>%
  summarise(fork_length = mean(fork_length)) 

cordoleani_fish <- merge(cordoleani_fish, cord_fork_length, by = "sample_id", all.x = T) 
cordoleani_fish <- cordoleani_fish %>%
  mutate(habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' ))))) %>%
  mutate(watershed = case_when(location == "Butte Sink" ~ "Butte Creek", 
                            location == "Sacramento River" ~ "Sacramento River", 
                            location == "Feather River" ~ "Feather River", 
                            location %in% c("Lower Bypass", "Upper Bypass") ~ 
                              "Sutter Bypass"), 
         site = paste0(location, "-", sample_id)) %>%
  select(-location, -sample_id) %>%
  glimpse


# view data snapshot
kable(head(cordoleani_fish, 5))

```

------------------------------------------------------------------------

##### Location Data Standardization

```{r}
cordoleani_locations <- cordoleani_locations_raw %>%
  rename(location = Region, 
         sample_id = Report_ID, 
         habitat_type = Type, 
         lon = long) %>%
  select(-Name,  -Report_type) %>%
  mutate(habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' ))))) %>%
  mutate(site = paste0(location, "-", sample_id)) %>%
  mutate(site_for_fish = paste0(location, "-", Site)) %>%
  select(-location, -sample_id) %>%
  glimpse


cordoleani_locations_sf <- st_as_sf(cordoleani_locations, coords = c('lon', 'lat'))

# leaflet(cordoleani_locations_sf) %>%
#   addEsriBasemapLayer(esriBasemapLayers$Imagery, 
#                       autoLabels=TRUE, group = 'Esri Basemap') %>%
#   addMarkers(popup = ~paste0(cordoleani_locations_sf$site, '; ', cordoleani_locations_sf$habitat_type )) 
```

------------------------------------------------------------------------

##### Combine datasets with location data

-   added lat/long to all Cordoleani datasets

```{r}

cordoleani_locations <- cordoleani_locations %>% select(-habitat_type)

cordoleani_zoop <- merge(cordoleani_zoop, cordoleani_locations, by = 'site') %>% select(-site_for_fish, -Site)
cordoleani_fish <- merge(cordoleani_fish, cordoleani_locations, by.x = 'site', by.y = 'site_for_fish')
cordoleani_enviro <- merge(cordoleani_enviro, cordoleani_locations, by = 'site') %>% select(-site_for_fish, -Site)

cordoleani_fish <- cordoleani_fish %>% 
  select(-site, -Site) %>%
  rename(site = site.y)

```

#### Data Exploration:

##### Zooplankton:

```{r message=FALSE, warning=FALSE}

ggplot(cordoleani_zoop, aes(y = prey_density, x = habitat_type)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) + 
  theme_minimal() 

ggplot(cordoleani_zoop, aes(x = date, y = prey_density)) +
  geom_point() + 
  theme_minimal() 

```

##### Fish Data:

```{r message=FALSE, warning=FALSE}
length(unique(cordoleani_fish$fish_id))

ggplot(cordoleani_fish, aes(mass)) +
  geom_histogram(aes(fill = habitat_type), position = "identity", alpha = .6) + 
  theme_minimal()

```

##### Environmental:

```{r message=FALSE, warning=FALSE, echo = TRUE}
ggplot(cordoleani_enviro, aes(x = temperature))+
  geom_histogram(aes(fill = site), position = "identity", alpha = .6) +
  facet_wrap(~watershed) + 
  theme_minimal()

```

### Zeug - San Joaquin River {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

```{r}
raw_zoops <- read_excel("san-joaquin-steve-zeug/summary_zooplankton_10_19_17.xlsx", 
                        sheet = "CountLiter2016", 
                        range = "A1:H56") 

kable(head(raw_zoops, 5))

```

#### Data Standardization

-   column `CountPerVolume` was used for `prey_density` and determined to have units of total prey/liter and kept as such

-   since we do not have sampling dates, I kept in `Year` and `Week`. We might want to remove these for the full standardized dataset.

-   added lat/longs provided by Steve Zeug

-   manually assigned `habitat_types` based on best professional judgement (see map below for verification)

```{r}
merced_sanJoaquin_zoops <- raw_zoops %>%
  rename(sample_id = Reach, 
         species = TaxGrp_1,
         count = TotalTaxbyReach,
         prey_density = CountperVolume) %>%# currently total prey/l
  select(sample_id, species, prey_density, Year, Week) %>% 
  mutate(author = "Zeug",
         watershed = 'San Joaquin',
         site = sample_id,
         size_class = "micro",
         species = tolower(species),
         gear_type = "10 liter Schindler-Patalas",
         mesh_size = 64) %>%
  select(-sample_id)

sj_locations <- data.frame(
  site = c('1A', '2A', '4B-CS', '4B-ESB'),
  habitat_type = c('perennial instream', 'perennial instream', 'side channel',  'perennial instream'),
  lat = c(36.860461, 36.798219, 37.166257, 37.166817),
  lon = c(-119.847043, -120.16085, -120.619793, -120.631145)
)

merced_sanJoaquin_zoops <- merge(merced_sanJoaquin_zoops, sj_locations, by = "site")

kable(head(merced_sanJoaquin_zoops, 5))
```

##### View locations

```{r}
sj_locations_sf <- st_as_sf(sj_locations, coords = c('lon', 'lat'))

# leaflet(sj_locations_sf) %>%
#   addEsriBasemapLayer(esriBasemapLayers$Imagery, 
#                       autoLabels=TRUE, group = 'Esri Basemap') %>%
#   addMarkers(popup = ~paste0(sj_locations_sf$site, '; ', sj_locations_sf$habitat_type )) 
```

```{r}
zeug_sanJoaquin_prey_data <- merced_sanJoaquin_zoops

#usethis::use_data(zeug_sanJoaquin_prey_data)

```

#### Data Exploration:

```{r}

ggplot(merced_sanJoaquin_zoops, aes(x = species, y = prey_density)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.5, aes(color = site)) + 
  coord_flip() + 
  theme_minimal()

ggplot(merced_sanJoaquin_zoops, aes(x = habitat_type, y = prey_density)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.5, aes(color = site)) + 
  coord_flip() + 
  theme_minimal()
```

### Zeug - Merced River {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

##### Raw Prey Data

```{r}

raw_df <- read_excel("merced-steve-zeug/Merced invert data_environment.xls", .name_repair = 'minimal', sheet = "erin_modified",  col_names = FALSE)

dates <- janitor::excel_numeric_to_date(as.numeric(raw_df[1,3:ncol(raw_df)]), date_system = 'mac pre-2011') %>% as.character()

sites <- raw_df[2, 3:ncol(raw_df)]

col_names <- append(
  c('Species', 'Measurement'),
  paste(dates, sites, sep = '__')
)

names(raw_df) <- col_names

# view subset of data
kable(head(raw_df, 10))

```

------------------------------------------------------------------------

##### Raw Fish Data

```{r}
raw_salmon <- read_excel("merced-steve-zeug/salmon data_final(Josie).xlsx", skip = 2) 

kable(head(raw_salmon, 5))
```

------------------------------------------------------------------------

##### Raw Temperature Data

```{r}
raw_temps <- read_excel("merced-steve-zeug/Temperature.xlsx", sheet = "Sheet1", range = "A1:U212") %>% 
  mutate(date = as.Date(`date/time`)) %>%
  select(-difference, -`date/time`) 

kable(head(raw_temps, 5))
```

#### Data Standardization

##### Prey Data Standardization

-   `gear_type` was extracted from column name

-   TO DO: check units for prey density. Currently using No. m-2 (subsam) and dividing by provided volume (m\^3) and converting to count/L.

```{r}

merced_steve_zeug_zoop <- raw_df[3:nrow(raw_df),] %>%
  fill(Species, .direction = 'down') %>% #TODO make sure species is accurate(looks like fill is tricky with xlsx format)
  filter(Measurement == 'No. m-2 (subsam)') %>% # is this the value we want for prey density??
  pivot_longer(cols = !c('Species', 'Measurement'), names_to = "date__site") %>%
  separate(col = date__site, into = c('date', 'site'), sep = '__') %>%
  rename(prey_density = value, #TODO: what is this unit, No. m-2 (subsam) ??
        date = date,
         sample_id = site,
         species = Species) %>%
  mutate(author = 'Zeug',
         life_stage = ifelse(grepl('Adult', species), 'Adult',
                             ifelse(grepl('Larvae', species), 'Larvae',
                                    ifelse(grepl('Pupae', species), 'Pupae',
                                           ifelse(grepl('Nymph', species), 'Nymph', NA)))),
         gear_type = ifelse(grepl('Drift', sample_id), 'Drift',
                            ifelse(grepl('Benthic', sample_id), 'Benthic', NA))) %>%
  mutate(tmp_name = gsub('Drift', '', sample_id), # extract sample_id
         name = stringr::str_split(tmp_name, " ") %>% map_chr(., 1),
         sample_id = ifelse(name == '', tmp_name, name ),
         size_class = "macro",
         watershed = "Merced",
         gear_type = tolower(gear_type),
         life_stage = tolower(life_stage),
         species = tolower(species),
         habitat_type = "perennial instream") %>%
  select(-c(tmp_name, name)) %>%
  mutate(sample_id = gdata::trim(sample_id),
         mesh_size = 500) %>%
  filter(gear_type == "drift") %>%
  mutate(gear_type = "net throw") %>%
  glimpse

# Load in volumns sampled from seperate xlsx sheet and use it to calculated count/L 
vols <- readxl::read_excel('merced-steve-zeug/Flow_meter_Drift.xlsx', skip = 4) %>% 
  janitor::clean_names() 

vols <- vols %>% select(site, corrected_voume_m3_s_1) %>% 
  filter(!is.na(corrected_voume_m3_s_1))

merced_steve_zeug_zoop <- merge(merced_steve_zeug_zoop, vols, by.y = "site", by.x = "sample_id" )

merced_steve_zeug_zoop <- merced_steve_zeug_zoop %>% 
  mutate(prey_density = as.numeric(prey_density)/corrected_voume_m3_s_1/1000, # convert from m^3 to L
         date = as.Date(date)) %>% 
  rename(site = sample_id) %>% 
  select(-corrected_voume_m3_s_1, -Measurement)

kable(head(merced_steve_zeug_zoop, 5))

```

------------------------------------------------------------------------

##### Fish Data Standardization

-   One outlier of 70 cm fish length removed from dataset

-   converted `fork_length` from centimeters to millimeters

-   removed columns `otolith code`, `isotope code`, and columns related to `tin weights` .

-   also removed all fish consumption data. This could easily be folded back in, unsure if it is necessary. [see commented out section]

```{r}
merced_steve_zeug_fish <- raw_salmon %>%
  filter(`Length of Fish (cm)` < 70) %>% # removes outlier
  rename(fish_id = `fish #`,
         site = Location,
         fork_length = `Length of Fish (cm)`,
         mass = `Weight of fish (g)`) %>%
  mutate(fork_length = fork_length * 10, # converts from cm to mm 
         author = 'Zeug',
         watershed = 'Merced') %>% 
  select(-c(`Otolith code`:comments)) 

kable(head(merced_steve_zeug_fish, 5))
```

------------------------------------------------------------------------

##### Temperature Data Standardization

-   Used average temperature instead of min, max

```{r}
merced_steve_zeug_temp <- raw_temps %>% 
  pivot_longer(cols = `23 max`:`BW mean`) %>% 
  separate(name, into = c("site", "measurement"), sep = " ") %>%
  rename(temperature = value,
         #sample_id = site, 
         date = date) %>%
  filter(measurement == 'mean') %>%
  select(-Month, -measurement) %>%
  mutate(author = 'Zeug',
         watershed = 'Merced') 

kable(head(merced_steve_zeug_temp, 5))
```

```{r}
# save data
zeug_merced_prey_data <- merced_steve_zeug_zoop
zeug_merced_fish_data <- merced_steve_zeug_fish
zeug_merced_enviro_data <- merced_steve_zeug_temp

# usethis::use_data(zeug_merced_prey_data)
# usethis::use_data(zeug_merced_fish_data)
# usethis::use_data(zeug_merced_enviro_data)

```

### Guignard - Stanislaus {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

##### Raw Prey Data

-   created a modified version of the tab *Density by location, date...* to make it easier to load into R

```{r}
stanislaus_zoop_raw <- read_excel("stanislaus-jason-guignard/Honolulu Bar data.xlsx", 
                                  sheet = 'Density by location, date,ta_MR') 

kable(head(stanislaus_zoop_raw, 5))
```

------------------------------------------------------------------------

##### Raw Temperature Data

```{r}
stanislaus_temp_data_raw <- read_excel("stanislaus-jason-guignard/Honolulu Bar data.xlsx", 
                                       sheet = 'FlowTemp')

kable(head(stanislaus_temp_data_raw, 5))
```

------------------------------------------------------------------------

##### Location Data

-   Changed .kmz tile to .kml for simplified loading into R

```{r}
locations <- st_read(dsn = 'stanislaus-jason-guignard/drift net sites_to_kml.kml')

# add lat and long columns based on geometry 
locations <- locations %>%
  dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2])

#kable(locations)
```

#### Data Standardization

##### Prey Data Standardization

-   Used `Total Drift Density` column as prey density value which needed to be converted from cubic feet to liters
-   removed the total prey density and left the prey density disaggregated by species
-   `site` = `location`

```{r}
stanislaus_zoop <- stanislaus_zoop_raw %>%
  rename(location = Location,
         prey_density_total = `Total  Drift Density`,# units are cubic feet
         other_taxa = `Other Taxa`) %>%
  mutate(prey_density_total = prey_density_total/28.3168) %>%  #1ft^3 = 28.3168 Liters  # this is the sum of all species     
  gather(!c('location', 'prey_density_total', 'Date'), key = species, value = value )%>%
  mutate(author = 'Guignard',
         watershed = 'Stanislaus',
         species = tolower(species)) %>%
  rename(prey_density = value,
         date = Date) %>%
  mutate(prey_density = prey_density/0.0283168, 
         site = location,
         gear_type = "net throw",
         mesh_size = 335,
         size_class = "meso/macro") %>% # size class is 335 micrometer mesh. 
  select(-prey_density_total, -location) 

kable(head(stanislaus_zoop, 5))
```

------------------------------------------------------------------------

##### Location Data Standardization

-   Match names of locations to the `stanislaus_zoop` table and merge them
-   Manually assign `habitat_type` using best professional judgement

```{r}

# locaton names of zoop data
unique(stanislaus_zoop$site)

# location names in .kmz 
unique(locations$Name)

# change the names of the locations dataset to match those in in the zoops table 
locations[locations$Name == "H Bar Main Channel", 'Name'] <- 'Main Channel'
locations[locations$Name == "Side Channel Upper", 'Name'] <- 'Top Side'
locations[locations$Name == "Side Channel Lower", 'Name'] <- 'Lower Side'
locations[locations$Name == "Floodplain Upper", 'Name'] <- 'Upper Flood Plain'
locations[locations$Name == "Middle Floodplain", 'Name'] <- 'Middle Flood Plain' 
locations[locations$Name == "Floodplain Lower", 'Name'] <- 'Lower Flood Plain'

locations <- locations %>%
  mutate(habitat_type = ifelse(Name %in% c('Main Channel'), 'perennial instream', 
                               ifelse(Name %in% c('Top Side', 'Lower Side'), 'side channel',
                                      ifelse(Name %in% c('Upper Flood Plain', 'Middle Flood Plain', 'Lower Flood Plain'), 'floodplain', NA)))
  ) %>%
  rename(site = Name)

# leaflet(locations) %>%
#   addEsriBasemapLayer(esriBasemapLayers$Imagery, 
#                       autoLabels=TRUE, group = 'Esri Basemap') %>%
#   addMarkers(popup = ~paste0(locations$site, ' ', locations$habitat_type )) 
```

##### Temperature Data Standardization

```{r}
stanislaus_temp_data <- stanislaus_temp_data_raw %>%
  mutate(author = 'Guignard',
         watershed = 'Stanislaus') %>%
  rename(date = Time,
         flow_cfs = `Flow cfs`,
         temperature = `Temp F`)
```

##### Combine location and prey datasets

```{r}
stanislaus_zoop <- merge(stanislaus_zoop, locations, by = 'site') %>% 
  select(-Description) 
```

```{r}
# save data
guignard_prey_data <- stanislaus_zoop
guignard_enviro_data <- stanislaus_temp_data

usethis::use_data(guignard_prey_data)
usethis::use_data(guignard_enviro_data)

```

### Montgomery {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

-   Data is currently located on EDI repository and downloaded directly into R

```{r, echo = TRUE, message = FALSE, warning = FALSE, include = FALSE}
# this a script that sources the EDI data
source('food_4_fish_data_access.R')
```

##### Raw Prey Data

```{r}

# zoops_table comes directly from EDI

kable(head(zoops_table, 5))
```

```{r}

# caged_fish comes directly from EDI

kable(head(caged_fish, 5))
```

##### Raw Temperature Data

-   this is extracted from the `zoops_table`

#### Data Standardization

##### Prey & Temperature Data Standardization

-   extracted temperature and dissolved oxygen from zooplankton data. `site` should link the two datasets.
-   Converted from count/m\^3 to count/L

```{r message = FALSE, warning = FALSE}
montgomery_zoop_tmp <- zoops_table %>%
  separate(id, c('location', 'Date'), '_') %>% 
  mutate(date = mdy(Date)) %>% 
  gather(!c('location', 'Date', 'date':'volume_sampled'), key = species, value = value) %>%
  separate(species, c('species', 'life_stage'), '_') %>%
  select(-c(Date, ec_s_cm:do_sat, p_h:volume_sampled)) %>%
  rename(temperature = temp_c,
         prey_density = value) %>%
  mutate(author = "Montgomery", 
         site = location,
         size_class = "meso",
         gear_type = "net throw",
         mesh_size = 150, 
         prey_density = prey_density/1000) #1 m^3 = 1000 L 


# extract out temperature, do
montgomery_temp <- montgomery_zoop_tmp %>%
  select(date, site, temperature, do_mg_l, author) 

# extract out relevant zoop data and filter to relevant prey_density 
montgomery_zoop <- montgomery_zoop_tmp %>%
  select(date, site, species:author, size_class, mesh_size, gear_type) %>%
  filter(prey_density > 0) 

kable(head(montgomery_zoop, 5))

kable(head(montgomery_temp, 5))
```

##### Raw Locations Data

-   downloaded locations data from EDI and manually assigned each habitat type based on best professional judgement

```{r}
# write.csv(location_lookup, 'mont_locations.csv')
montgomery_locations <- read.csv('mont_locations.csv') %>%
  rename(site = location,
         watershed = stream) 

kable(head(montgomery_locations, 5))
```

##### Fish Data Standardization

```{r}
montgomery_fish <- caged_fish %>%
  rename(site = LOCATION, 
         fish_id = PIT, 
         fork_length = Length.mm,
         mass = Weight.g,
         date = Date) %>%
  mutate(date = as_date(mdy(date)),
         author = "Montgomery")

kable(head(montgomery_fish, 5))
```

##### Locations standardization

-   used lat/long to assign geometry for each sampling location
-   manually assigned each `habitat_type`. Click on marker to see description in map below.

```{r}

# create a simple feature 
montgomery_locations_sf <- st_as_sf(montgomery_locations, coords = c('lon', 'lat'))

```

##### Combine locations with zoops data

```{r}
montgomery_zoop <- merge(montgomery_zoop, montgomery_locations, by = "site") 

montgomery_zoop <- montgomery_zoop %>%
  select(-notes)

montgomery_fish <- merge(montgomery_fish, montgomery_locations, by = "site") %>%
  select(-notes)
```

```{r}
# save data
montogomery_prey_data <- montgomery_zoop
montgomery_fish_data <- montgomery_fish
montgomery_enviro_data <- montgomery_temp

usethis::use_data(montogomery_prey_data)
usethis::use_data(montgomery_fish_data)
usethis::use_data(montgomery_enviro_data)

```

### Zooper R library

-   download data from Zooper library [[Intergency Ecological Program](https://github.com/InteragencyEcologicalProgram/zooper)]
-   convert from count/m\^3 to count/L
-   extract `temperature` into unique environmental dataset

```{r}
# zoop_data <- Zoopsynther(Data_type = "Community", 
#                        Sources = c("EMP", "FRP", 
#                                    "FMWT", "STN", "20mm"), 
#                        Size_class = c("Micro", "Meso", "Macro"), 
#                        Date_range = c("1990-10-01", "2020-09-30"))

#saveRDS(zoop_data, 'zoop_data.rds')
zoop_data <- readRDS('zoop_data.rds')

zooper <- zoop_data %>%
  select(date = Date, prey_per_unit_volume = CPUE, species = Taxname, life_stage = Lifestage, 
         size_class = SizeClass, author = Source, site = SampleID, 
         temperature = Temperature, lat = Latitude, lon = Longitude) %>% 
  mutate(author = paste0('zooper: ', author), 
         species = tolower(species), 
         size_class = tolower(size_class), 
         life_stage = tolower(life_stage), 
         prey_density = prey_per_unit_volume/1000)  # convert to count/L from count/m^3


# Add in categorization of North Delta or South Delta 
# Adds polygon for each site
delta_extents <- rgdal::readOGR("../data-raw/shape_files/delta_extents/HabitatExtentsForCorreigh.shp") %>%
  st_as_sf(coords = c("longitude", "latitude"), dim = "XY", crs = 4326) %>%
  st_transform("WGS84")

sf_zooper_points <- st_as_sf(zooper %>% filter(!is.na(lon), !is.na(lat)), coords = c('lon', 'lat'), crs = 4326, remove = FALSE)

zooper_with_watershed <- st_join(delta_extents, sf_zooper_points) %>%
  st_set_geometry(NULL) %>%
  glimpse()

# extract temperature 
zooper_temperature <- zooper %>%
  select(date, temperature, author, site, lat, lon)

zooper_prey_data <- zooper_with_watershed %>%
    select(-Id, -prey_per_unit_volume, -temperature) %>%
    mutate(habitat_type = ifelse(watershed == 'Yolo Bypass 2', 'floodplain', 'perennial instream')) %>%
    filter(!is.na(author)) # filter out watershed designations with no intersection

kable(head(zooper_prey_data, 5))
kable(head(zooper_temperature, 5))

```

```{r}
# save data
zooper_enviro_data <- zooper_temperature

usethis::use_data(zooper_prey_data)
usethis::use_data(zooper_enviro_data)
```
# Size Class Methodology

-   Size Class methodology defined by [Interagency Ecological Program](https://github.com/InteragencyEcologicalProgram/zooper)

    -   Macro (500 - 505 Î¼m): Amphipods and mysids

    -   Meso (150 - 160 Î¼m): Copepods, cladocera

    -   Micro (43 - 50 Î¼m): Copepods, rotifers

    -   Nets accurately sample zooplankton larger than the mesh size. Zooplankton smaller than the mesh size are still captured and often recorded in datasets, but the resulting CPUEs are not accurate. To account for this we:

*Mesh size availability by dataset* to inform size class definition

| Dataset                  | Mesh Size                                 | Gear Type                  | Life Stage                                                                                                       | Other Species Info                                                                                   |
|---------------|---------------|---------------|---------------|---------------|
| Cordoleani               | 30 cm diameter 150 Âµm mesh                | Net Throw                  |                                                                                                                  |                                                                                                      |
| Corline                  | 153-154 Mesh Size (microns)               | Net Throw                  | adult, nauplii, juevenile, embryo, egg, larvae, pupae, nympth                                                    | By column: Phylum, Subclass, Order, Family, Genus, Species                                           |
| Steve Zeug - San Joaquin | 64 micron mesh                            | 10 liter Schindler-Patalas | NA                                                                                                               | species (group): Microcrustacea, Insecta-Diptera, Arachnid, Tardigrada, Insecta-Ephemeroptera        |
| Stanislaus               | 335 micrometer mesh; 1 sqft opening       | drift net                  | NA                                                                                                               | By column, species Order: Ephemeroptera, Plecoptera, Tricoptera, Diptera, Microcrustacea, Other Taxa |
| Montgomery               | 30-cm diameter x 150 Âµm mesh              | Net Tow                    | adult, sphaericus, sp, embryo, copepididte, pulex, nauplii, copepidite, mendotea, magna, insect, naulpii, larvae | species                                                                                              |
| Steve Zeug - Merced      | 47 x 28 cm diameter; 500 micron mesh size |                            |                                                                                                                  |                                                                                                      |

# Combine All Datasets {.tabset .tabset-fade .tabset-pills}

## Prey Data

### Combine Prey Data

```{r, warning = FALSE, message = FALSE}

all_prey <- bind_rows(cordoleani_zoop, 
                      corline_zoop, 
                      merced_sanJoaquin_zoops, 
                      zooper_prey_data,
                      merced_steve_zeug_zoop, 
                      montgomery_zoop, 
                      stanislaus_zoop) %>%
  #select(-geometry, -Year, -Week) %>%
  mutate(watershed = ifelse(watershed == "Feather River ", "Feather River", watershed))

kable(head(all_prey, 10))
# View(all_prey)

all_prey_density <- all_prey

usethis::use_data(all_prey_density)
```

### Explore Prey Data

#### Log Transformed Prey Density

Explore prey density using log transformed data.

```{r}
ggplot() +
  geom_boxplot(data = all_prey, aes(x = author, y = prey_density)) +
  scale_y_continuous(trans='log10') + 
  ylab('log10 prey_density') + 
  coord_flip()

ggplot() +
  geom_boxplot(data = all_prey, aes(x = habitat_type, y = prey_density)) +
  scale_y_continuous(trans='log10') + 
  ylab('log10 prey_density') + 
  coord_flip()

ggplot() +
  geom_boxplot(data = all_prey, aes(x = size_class, y = prey_density)) +
  scale_y_continuous(trans='log10') + 
  ylab('log10 prey_density') + 
  coord_flip()

```

#### Raw Data Visualization 

```{r}
all_prey %>%
  group_by(habitat_type) %>%
  select(prey_density) %>%
  summarise_if(is.numeric, .funs = c("mean", "min", "max", "var"), na.rm = TRUE) %>% 
  kable(digits=1, format.args = list(big.mark = ","))


ggplot() +
  geom_boxplot(data = all_prey, aes(x = author, y = prey_density)) +
  coord_flip()

ggplot() +
  geom_boxplot(data = all_prey, aes(x = author, y = prey_density)) +
  facet_wrap(~size_class, scale = "free") + 
  coord_flip()

ggplot() +
  geom_boxplot(data = all_prey, aes(x = watershed, y = prey_density)) +
  facet_wrap(~habitat_type, scale = "free") + 
  theme(axis.text.x = element_text(angle = 45)) +
  coord_flip() 

ggplot() +
  geom_point(data = all_prey, aes(x = date, y = prey_density)) +
  facet_wrap(~author, scales= "free_y")

```

------------------------------------------------------------------------

## Fish Data

```{r, echo = FALSE}
# general housekeeping, doesn't need to be shared 
montgomery_fish <- as.data.frame(montgomery_fish)
cordoleani_fish$fish_id <- as.character(cordoleani_fish$fish_id)
merced_steve_zeug_fish$fish_id <- as.character(merced_steve_zeug_fish$fish_id)
```

```{r}

all_fish <- bind_rows(cordoleani_fish, 
                      merced_steve_zeug_fish,
                      montgomery_fish
) 

kable(head(all_fish, 10))

all_fish_data <- all_fish

usethis::use_data(all_fish_data)

```

### Explore Fish Data

```{r}
ggplot() +
  geom_boxplot(data = all_fish, aes(x = author, y = fork_length)) +
  coord_flip()


ggplot() +
  geom_boxplot(data = all_fish, aes(x = habitat_type, y = fork_length)) +
  coord_flip()

ggplot() +
  geom_boxplot(data = all_fish, aes(x = habitat_type, y = mass)) +
  coord_flip()


```

------------------------------------------------------------------------

## Environmental Data

```{r}
all_enviro <- bind_rows(cordoleani_enviro,
                        merced_steve_zeug_temp,
                        montgomery_temp,
                        stanislaus_temp_data,
                        zooper_temperature)

kable(head(all_enviro, 10))

all_enviro_data <- all_enviro

usethis::use_data(all_enviro_data)
```

### Explore Environmental Data

```{r}
ggplot() +
  geom_point(data = all_enviro, aes(x = date, y = temperature, color = author)) +
 facet_wrap(~author) 

do <- all_enviro %>% filter(author %in% c('Cordoleani', 'Montgomery'))
ggplot() +
  geom_point(data = do, aes(x = date, y = do_mg_l)) +
  facet_wrap(~author, scales = 'free')
```
