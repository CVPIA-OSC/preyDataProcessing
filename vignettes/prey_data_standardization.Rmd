---
title: "prey data standardization"
author: "Maddee Rubenson (FlowWest)"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE, message = FALSE, warning = FALSE
)

library(tidyverse)
library(lubridate)
library(knitr)
library(readxl)
library(sf)
library(DT)
library(preyDataProcessing)

options(scipen=999)
```

# Load Datasets {.tabset .tabset-fade .tabset-pills}

### Corline et al. {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

```{r}
excel_path <- system.file("extdata", "corline", "Zoop2013_2016_NC.xlsx", package = "preyDataProcessing")
corline_raw_zoop <- readxl::read_excel(excel_path) |> glimpse()

#kable(head(corline_raw_zoop, 5))
```

#### Data Standardization

-   Defined prey density as `Ind_per_L` which was calculated as the
    ratio of field volume and sample totals.

-   Along with `gear_type` included in the dataset are the number of
    throws (`n_throws`) and mesh size (`mesh_size_microns`). Mesh size
    is used to determine the `size_class` variable.

-   Variables Removed: `Split Fraction`, `Class`, `Subclass`, `Order`,
    `Genus`, `Family`

-   Left `species` column

-   Fixed naming conventions of the sampling locations (`sample_id`)

-   TODO: reconcile inconsistent species spelling names

```{r, warnings = FALSE, message=FALSE}
corline_zoop_tmp <- corline_raw_zoop  |> 
  rename(location = Location, 
         gear_type = Method, 
         life_stage = `Life Stage`) |> 
  mutate(prey_density = Ind_per_L,
         Date = as_date(Date)) |> 
  select(-c(`Split Fraction`:`Volume subsampled (ml)`), -Count, -c(Phylum:Genus)) %>%
  rename(sample_id = Field, 
         species = Species, 
         n_throws = Throws, 
         mesh_size_microns = `Mesh Size (microns)`,
         date = Date) |> 
  select(-`Total Volume (ml)`, -`Ring Size (cm)`, -Ind_per_m3,
         -Ind_per_L, -...25, -...26, -Field_Volume_m3, -Inverse_Fraction, 
         -Sample_Total_Count) |> 
  mutate(author = "Corline",
         size_class = "meso",
         species = tolower(species),
         gear_type = tolower(gear_type),
         mesh_size = mesh_size_microns) 

# Numeric sample Ids must be standardized with Fields. Looks like 2015 data has 1 - 9 as sample Id while data from 2013 has Field 1 - Field 9. This is updated to have the sample_ids as follows, where the NA corresponds to the sites on the Sacramento River. 
tmp_change_names <- corline_zoop_tmp[corline_zoop_tmp$sample_id %in% c(1:10), ] %>%
  mutate(sample_id = paste0('Field ', sample_id))
tmp_names_with_field <- corline_zoop_tmp[!(corline_zoop_tmp$sample_id %in% c(1:10)), ]
corline_zoop_tmp <- bind_rows(tmp_change_names, tmp_names_with_field)

# this fixes the spelling differences in species column 
corline_zoop <- corline_zoop_tmp |> 
  mutate(species = case_when(species %in% c("harpacticoid", "harpacticoida") ~ "harpacticoida",
                             species %in% c("illyocryptidae", "ilyocryptidae") ~ "ilyocryptidae",
                             species %in% c("schaploberis", "schaphloberis") ~ "schaphloberis", 
                             species == "species" ~ NA_character_, 
                             TRUE ~ species))  |> 
  select(-n_throws, -mesh_size_microns) 

kable(head(corline_zoop, 5))

```

##### Location Data Standardization

-   location of the fields (Knaggs Ranch) were provided by author

-   location of inlet canal (Toe Drain) was determined based on best
    professional judgement and the paper Corline et al.

-   location of the Sacramento River sampling site was provided in the
    paper Corline et al. as Sherwood Harbor

-   defined `habitat_type` based on best professional judgement

```{r}

corline_locations <- data.frame(
  location = c('Knaggs Ranch', 'Sacramento River', 'Toe Drain'),
  habitat_type = c('floodplain', 'perennial instream', 'agricultural canal'), # TODO update these habitat designations per recommendations from J. Montgomery
  lat = c(38.70151, 38.52353, 38.70511),
  lon = c( -121.66996, -121.53840, -121.67041)
)

corline_zoop_final <- corline_zoop |> 
  left_join(corline_locations) |>  
   mutate(watershed = ifelse(location == "Sacramento River", "Sacramento River", "Yolo Bypass"),
         site = ifelse(location == "Sacramento River", "Sherwood Harbor", location)) %>%
  mutate(site = paste0(location, "-", sample_id)) %>%
  select(-sample_id, -location) 

kable(head(corline_zoop_final, 5))


```

### Cordoleani et al. {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

```{r message=FALSE, warning=FALSE}
path <- system.file("extdata", "cordoleani", "tidy_zoop_density.csv", package = "preyDataProcessing")
cordo_prey_raw <- read_csv(path) |> glimpse()


```

------------------------------------------------------------------------

##### Raw Location Data

```{r}

path <- system.file("extdata", "cordoleani", "Cage_Locations.csv", package = "preyDataProcessing")
cordoleani_locations_raw <- read_csv(path) |> glimpse()

```

#### Data Standardization

-   Chose to not use interpolated or filled values for prey density

-   Removed temperature to include as a standalone dataset that can be
    mapped to this dataset using `sample_id` and `date`

-   Defined `sample_id` as `cage_id`

-   mapped `Canal channel` and `Agriculture` to `agricultural canal`

-   mapped `Channel` and `River Channel` to `perennial instream`

-   mapped `Wetland` to `floodplain`

-   Changed units for `prey_density` from count/m\^3 to count/L

```{r}

cordoleani_zoop <- cordo_prey_raw %>% 
  rename(prey_density = value, # units are organisms/m^3 per Sutter 2020 report 
         sample_id = report_id,
         date = sample_date,
         location = region,
         species = taxa) %>%
  mutate(date = mdy(date),
         prey_density = prey_density/1000, # 1 m^3 = 1000 Liters 
         author = 'Cordoleani',
         habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' )))),
         watershed = case_when(location == "Butte Sink" ~ "Butte Creek", 
                            location == "Sacramento River" ~ "Sacramento River", 
                            location == "Feather River" ~ "Feather River", 
                            location %in% c("Lower Bypass", "Upper Bypass") ~ 
                              "Sutter Bypass"), 
         site = paste0(location, "-", sample_id),
         size_class = "meso",
         gear_type = "net throw",
         mesh_size = 150,
         species = tolower(species)) %>% 
         select(-location, -sample_id, -year) 

# view data snapshot
kable(head(cordoleani_zoop, 5))

```

##### Location Data Standardization

```{r}
# TODO: review location data
cordoleani_locations <- cordoleani_locations_raw %>%
  rename(location = Region, 
         sample_id = Report_ID, 
         habitat_type = Type, 
         lon = long) %>%
  select(-Name,  -Report_type) %>%
  mutate(habitat_type = ifelse(habitat_type == "Agriculture", 'agricultural canal',
                               ifelse(habitat_type == 'Channel', 'perennial instream',
                                      ifelse(habitat_type == "River Channel", 'perennial instream',
                                             ifelse(habitat_type == 'Wetland', 'floodplain', 'agricultural canal' ))))) %>%
  mutate(site = paste0(location, "-", sample_id)) %>%
  mutate(site_for_fish = paste0(location, "-", Site)) %>%
  select(-location, -sample_id, -habitat_type) %>%
  glimpse()


```

##### Combine datasets with location data

```{r}
cordoleani_zoop_final <- cordoleani_zoop |> 
  left_join(cordoleani_locations) |> 
  select(-site_for_fish, -Site)

kable(head(cordoleani_zoop_final, 5))

```

### Zeug - San Joaquin River {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

```{r}
path <- system.file("extdata", "zeug", "san_joaquin", "summary_zooplankton_10_19_17.xlsx", package = "preyDataProcessing")
zeug_prey_data_raw <- readxl::read_excel(path, sheet = "CountLiter2016", range = "A1:H56") |> glimpse()

```

#### Data Standardization

-   column `CountPerVolume` was used for `prey_density` and determined
    to have units of total prey/liter and kept as such

-   since we do not have sampling dates, I kept in `Year` and `Week`. We
    might want to remove these for the full standardized dataset.

-   added lat/longs provided by Steve Zeug

-   manually assigned `habitat_types` based on best professional
    judgement (see map below for verification)

```{r}
zeug_prey_data_san_joaquin <- zeug_prey_data_raw %>%
  rename(sample_id = Reach, 
         species = TaxGrp_1,
         count = TotalTaxbyReach,
         prey_density = CountperVolume) %>%# currently total prey/l
  select(sample_id, species, prey_density, Year, Week) %>% 
  mutate(author = "Zeug",
         watershed = 'San Joaquin',
         site = sample_id,
         size_class = "micro",
         species = tolower(species),
         gear_type = "10 liter Schindler-Patalas",
         mesh_size = 64) %>%
  select(-sample_id)

sj_locations <- data.frame(
  site = c('1A', '2A', '4B-CS', '4B-ESB'),
  habitat_type = c('perennial instream', 'perennial instream', 'side channel',  'perennial instream'),
  lat = c(36.860461, 36.798219, 37.166257, 37.166817),
  lon = c(-119.847043, -120.16085, -120.619793, -120.631145)
)

zeug_prey_data_san_joaquin_final <- zeug_prey_data_san_joaquin |> 
  left_join(sj_locations) 

kable(head(zeug_prey_data_san_joaquin_final, 5))

```
### Zeug - Merced River {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

##### Raw Prey Data

```{r}

path <- system.file("extdata", "zeug", "merced", "Merced invert data_environment.xls", package = "preyDataProcessing")
zeug_merced_prey_data_raw <- readxl::read_excel(path, .name_repair = 'minimal', sheet = "erin_modified",  col_names = FALSE)

dates <- janitor::excel_numeric_to_date(as.numeric(zeug_merced_prey_data_raw[1,3:ncol(zeug_merced_prey_data_raw)]), date_system = 'mac pre-2011') %>% as.character()

sites <- zeug_merced_prey_data_raw[2, 3:ncol(zeug_merced_prey_data_raw)]

col_names <- append(
  c('Species', 'Measurement'),
  paste(dates, sites, sep = '__')
)

names(zeug_merced_prey_data_raw) <- col_names

# view subset of data
zeug_merced_prey_data_raw |> glimpse()

```

#### Data Standardization

##### Prey Data Standardization

-   `gear_type` was extracted from column name

-   TODO: check units for prey density. Currently using No. m-2 (subsam) and dividing by provided volume (m\^3) and converting to count/L.

- TODO: do not have location data for Merced sites 

```{r}

zeug_merced_prey_data <- zeug_merced_prey_data_raw[3:nrow(zeug_merced_prey_data_raw),] %>%
  fill(Species, .direction = 'down') %>% #TODO make sure species is accurate(looks like fill is tricky with xlsx format)
  filter(Measurement == 'No. m-2 (subsam)') %>% # is this the value we want for prey density??
  pivot_longer(cols = !c('Species', 'Measurement'), names_to = "date__site") %>%
  separate(col = date__site, into = c('date', 'site'), sep = '__') %>%
  rename(prey_density = value, #TODO: what is this unit, No. m-2 (subsam) ??
        date = date,
         sample_id = site,
         species = Species) %>%
  mutate(author = 'Zeug',
         life_stage = ifelse(grepl('Adult', species), 'Adult',
                             ifelse(grepl('Larvae', species), 'Larvae',
                                    ifelse(grepl('Pupae', species), 'Pupae',
                                           ifelse(grepl('Nymph', species), 'Nymph', NA)))),
         gear_type = ifelse(grepl('Drift', sample_id), 'Drift',
                            ifelse(grepl('Benthic', sample_id), 'Benthic', NA))) %>%
  mutate(tmp_name = gsub('Drift', '', sample_id), # extract sample_id
         name = stringr::str_split(tmp_name, " ") %>% map_chr(., 1),
         sample_id = ifelse(name == '', tmp_name, name ),
         size_class = "macro",
         watershed = "Merced",
         gear_type = tolower(gear_type),
         life_stage = tolower(life_stage),
         species = tolower(species),
         habitat_type = "perennial instream") %>%
  select(-c(tmp_name, name)) %>%
  mutate(sample_id = gdata::trim(sample_id),
         mesh_size = 500) %>%
  filter(gear_type == "drift") %>%
  mutate(gear_type = "net throw") %>%
  glimpse()

# # Load in volumes sampled from separate xlsx sheet and use it to calculated count/L 
path <- system.file("extdata", "zeug", "merced", "Flow_meter_Drift.xlsx", package = "preyDataProcessing")
vols <- readxl::read_excel(path, skip = 4) %>%
  janitor::clean_names()

vols <- vols %>% select(site, corrected_voume_m3_s_1) %>%
  filter(!is.na(corrected_voume_m3_s_1)) |> 
  rename(sample_id = site)

zeug_merced_prey_data_final <- zeug_merced_prey_data |> 
  left_join(vols) |> 
  mutate(prey_density = as.numeric(prey_density)/corrected_voume_m3_s_1/1000, # convert from m^3 to L
         date = as.Date(date)) %>%
  rename(site = sample_id) %>%
  select(-corrected_voume_m3_s_1, -Measurement)
                                
kable(head(zeug_merced_prey_data_final, 5))

```

### Guignard - Stanislaus {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

-   created a modified version of the tab *Density by location, date...* to make it easier to load into R

```{r}
path <- system.file("extdata", 'guignard', "Honolulu Bar data.xlsx", package = "preyDataProcessing")
stanislaus_zoop_raw <- readxl::read_excel(path, sheet = 'Density by location, date,ta_MR')


path <- system.file("extdata", 'guignard', "Honolulu Bar data_05062022.xlsx", package = "preyDataProcessing")
stanislaus_zoop_raw_2 <- readxl::read_excel(path, sheet = 'Raw_data')

stanislaus_zoop_raw |> glimpse()
```

##### Location Data

-   Changed .kmz tile to .kml for simplified loading into R

```{r}
path <- system.file("extdata", 'guignard', "drift net sites_to_kml.kml", package = "preyDataProcessing")
locations_raw <- st_read(dsn = path) 
geometry <- sf::st_coordinates(locations_raw) |> cbind(locations_raw)


```

#### Data Standardization

##### Prey Data Standardization

-   Used `Total Drift Density` column as prey density value which needed to be converted from cubic feet to liters
-   removed the total prey density and left the prey density disaggregated by species
-   `site` = `location`

```{r}

stanislaus_zoop <- stanislaus_zoop_raw %>%
  rename(location = Location,
         prey_density_total = `Total  Drift Density`,# units are cubic feet
         other_taxa = `Other Taxa`) %>%
  mutate(prey_density_total = prey_density_total/28.3168) %>%  #1ft^3 = 28.3168 Liters  # this is the sum of all species     
  gather(!c('location', 'prey_density_total', 'Date'), key = species, value = value )%>%
  mutate(author = 'Guignard',
         watershed = 'Stanislaus',
         species = tolower(species)) %>%
  rename(prey_density = value,
         date = Date) %>%
  mutate(prey_density = prey_density/0.0283168, 
         site = location,
         gear_type = "net throw",
         mesh_size = 335,
         size_class = "meso/macro") %>% # size class is 335 micrometer mesh. 
  select(-prey_density_total, -location) |> 
  glimpse()
```

##### Location Data Standardization

-   Match names of locations to the `stanislaus_zoop` table and merge them
-   Manually assign `habitat_type` using best professional judgement

```{r}

# locaton names of zoop data
unique(stanislaus_zoop$site)

# location names in .kmz 
unique(locations$Name)

# change the names of the locations dataset to match those in in the zoops table 
locations[locations$Name == "H Bar Main Channel", 'Name'] <- 'Main Channel'
locations[locations$Name == "Side Channel Upper", 'Name'] <- 'Top Side'
locations[locations$Name == "Side Channel Lower", 'Name'] <- 'Lower Side'
locations[locations$Name == "Floodplain Upper", 'Name'] <- 'Upper Flood Plain'
locations[locations$Name == "Middle Floodplain", 'Name'] <- 'Middle Flood Plain' 
locations[locations$Name == "Floodplain Lower", 'Name'] <- 'Lower Flood Plain'

locations <- locations %>%
  mutate(habitat_type = ifelse(Name %in% c('Main Channel'), 'perennial instream', 
                               ifelse(Name %in% c('Top Side', 'Lower Side'), 'side channel',
                                      ifelse(Name %in% c('Upper Flood Plain', 'Middle Flood Plain', 'Lower Flood Plain'), 'floodplain', NA)))
  ) %>%
  rename(site = Name)

guignard_prey_data_final <- stanislaus_zoop |> 
  left_join(locations) |> 
  select(-Description)

kable(head(guignard_prey_data_final, 5))

```

### Montgomery {.tabset .tabset-fade .tabset-pills}

#### Load Raw Data

-   Data is currently located on EDI repository and downloaded directly into R

```{r, echo = TRUE, message = FALSE, warning = FALSE, include = FALSE}
# this a script that sources the EDI data
path <- system.file("extdata", "montgomery", "food_4_fish_data_access.R", package = "preyDataProcessing")
source(path)
```

##### Raw Prey Data

```{r}

# zoops_table comes directly from EDI

kable(head(montogomery_prey_data, 5))
```
##### Prey Data Standardization

-   extracted temperature and dissolved oxygen from zooplankton data. `site` should link the two datasets.
-   Converted from count/m\^3 to count/L

```{r message = FALSE, warning = FALSE}
montgomery_prey_data_process <- montgomery_prey_data %>%
  separate(id, c('location', 'Date'), '_') %>% 
  mutate(date = mdy(Date)) %>% 
  gather(!c('location', 'Date', 'date':'volume_sampled'), key = species, value = value) %>%
  separate(species, c('species', 'life_stage'), '_') %>%
  select(-c(Date, ec_s_cm:do_sat, p_h:volume_sampled)) %>%
  rename(temperature = temp_c,
         prey_density = value) %>%
  mutate(author = "Montgomery", 
         site = location,
         size_class = "meso",
         gear_type = "net throw",
         mesh_size = 150, 
         prey_density = prey_density/1000) |> #1 m^3 = 1000 L 
  select(date, site, species:author, size_class, mesh_size, gear_type) %>%
  filter(prey_density > 0) 

```

##### Raw Locations Data

-   downloaded locations data from EDI and manually assigned each habitat type based on best professional judgement

```{r}
# write.csv(location_lookup, 'mont_locations.csv')
path <- system.file("extdata", "montgomery",  "mont_locations.csv", package = "preyDataProcessing")
# montgomery_locations <- read_csv(path) %>%
#   rename(site = location,
#          watershed = stream) 

montgomery_locations # TODO upate this with habtiat types from Montgomery 


montgomery_prey_data_final <- montgomery_prey_data_process |> 
  left_join(montgomery_locations |> janitor::clean_names() |> 
              rename(site = location))

kable(head(montgomery_prey_data_final, 5))

```
